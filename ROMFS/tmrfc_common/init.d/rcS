#!nsh
#
# TMRFC start-up script.

#
# Default to auto-start mode.  An init script on the microSD card
# can change this to prevent automatic start-up of the flight script.
#
set MODE autostart
echo "[init] MODE ="$MODE

#
# Try to mount the microSD card.
#
echo "[init] Looking for microSD..."
if mount -t vfat /dev/mmcsd0 /fs/microsd
then
	echo "[init] Card mounted at /fs/microsd"
	# Start playing the startup tune
	echo "[init] tone_alarm start"
	tone_alarm start
else
	echo "[init] No microSD card found"
	# Play SOS
	tone_alarm error
fi

#
# Look for an init script on the microSD card.
#
# To prevent automatic startup in the current flight mode,
# the script should set MODE to some other value.
#
if [ -f /fs/microsd/etc/rc ]
then
	echo "[init] Reading /fs/microsd/etc/rc"
	sh /fs/microsd/etc/rc
fi
# Also consider rc.txt files
if [ -f /fs/microsd/etc/rc.txt ]
then
	echo "[init] Reading /fs/microsd/etc/rc.txt"
	sh /fs/microsd/etc/rc.txt
fi

if [ $MODE == autostart ]
then
	#
	# Start terminal
	#
	#if sercon
	#then
	#	echo "USB connected"
	#fi
	
	#
	# Start the ORB (first app to start)
	#
	echo "[init] Start the ORB"
	uorb start
	
	#
	# Load microSD params
	#
	if ramtron start
	then
		param select /ramtron/params
		if [ -f /ramtron/params ]
		then
			echo "[init] param load /ramtron/params"
			param load /ramtron/params
		fi
	else
		param select /fs/microsd/params
		if [ -f /fs/microsd/params ]
		then
			echo "[init] param load /fs/microsd/params"
			param load /fs/microsd/params
		fi
	fi
	
	#
	# Try to get an USB console
	#
	#nshterm /dev/ttyACM0 &
	
	#
	# Check if auto-setup from one of the standard scripts is wanted
	# SYS_AUTOSTART = 0 means no autostart (default)
	#
	
	if param compare SYS_AUTOSTART 1
	then
	sh /etc/init.d/01_quad_x
	fi

	
	# Start any custom extensions that might be missing
	if [ -f /fs/microsd/etc/rc.local ]
	then
		echo "[init] Reading /fs/microsd/etc/rc.local"
		sh /fs/microsd/etc/rc.local
	fi
	
	# If none of the autostart scripts triggered, get a minimal setup
	if [ $MODE == autostart ]
	then
		# Telemetry port is on both FC boards ttyS1
		#echo "[init] Start mavlink ( 57600  /dev/ttyS1 )"
		#mavlink start -b 57600 -d /dev/ttyS1
		#usleep 5000
	
		# Start commander
		echo "[init] Start commander"
		commander start
	
		# Start FC driver
		if fc mode_serial
		then
			echo "FC driver (no PWM) started"
		fi
	
		# Start sensors
		echo "[init] Start sensors"
		sh /etc/init.d/rc.sensors

		# Start one of the estimators
		sleep 3
		echo "[init] Start attitude_estimator_ekf"
		attitude_estimator_ekf start
	
		# Start GPS
		echo "[init] Start GPS >> need to implement"
		#gps start
	
	fi
# End of autostart
fi
